# EZREC Backend - Raspberry Pi Deployment Guide

This guide will help you deploy the EZREC Backend on a Raspberry Pi with systemd services for automatic startup and management.

## Prerequisites

- Raspberry Pi 4 (recommended) or Raspberry Pi 3B+
- Raspberry Pi OS (Bullseye or newer)
- Camera module (Pi Camera or USB camera)
- MicroSD card (32GB+ recommended)
- Power supply (5V/3A recommended)
- Network connection (WiFi or Ethernet)

## Quick Installation

### 1. Prepare Your Raspberry Pi

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Enable camera interface
sudo raspi-config
# Navigate to: Interface Options > Camera > Enable
```

### 2. Clone and Install

```bash
# Clone the repository
git clone https://github.com/yourusername/EZREC-BackEnd.git
cd EZREC-BackEnd

# Make setup script executable
chmod +x raspberry_pi_setup.sh

# Run the installation script
sudo ./raspberry_pi_setup.sh
```

### 3. Configure Environment

```bash
# Edit the configuration file
sudo nano /opt/ezrec-backend/.env
```

Add your Supabase credentials:
```env
# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
SUPABASE_ANON_KEY=your_anon_key

# User Configuration
USER_ID=your_user_id
USER_EMAIL=your_email@example.com

# Camera Configuration
CAMERA_ID=raspberry_pi_camera
CAMERA_NAME=Raspberry Pi Camera
CAMERA_LOCATION=Your Location
CAMERA_DEVICE=/dev/video0
CAMERA_WIDTH=1920
CAMERA_HEIGHT=1080
CAMERA_FPS=30

# Recording Configuration
RECORDING_DIR=/opt/ezrec-backend/recordings
LOG_DIR=/opt/ezrec-backend/logs
TEMP_DIR=/opt/ezrec-backend/temp
UPLOAD_DIR=/opt/ezrec-backend/uploads

# System Configuration
DEBUG=false
LOG_LEVEL=INFO
```

### 4. Start Services

```bash
# Start all services
sudo /opt/ezrec-backend/manage.sh start

# Check status
sudo /opt/ezrec-backend/manage.sh status

# View logs
sudo /opt/ezrec-backend/manage.sh logs
```

## Manual Installation (Alternative)

If you prefer manual installation or need to customize the setup:

### 1. Install System Dependencies

```bash
sudo apt update
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-opencv \
    ffmpeg \
    v4l-utils \
    libopencv-dev \
    libatlas-base-dev \
    git \
    curl \
    wget
```

### 2. Create Service User

```bash
sudo useradd -r -s /bin/bash -d /opt/ezrec-backend -m ezrec
sudo usermod -a -G video ezrec
```

### 3. Setup Application

```bash
# Create application directory
sudo mkdir -p /opt/ezrec-backend
sudo chown -R ezrec:ezrec /opt/ezrec-backend

# Copy application files
sudo cp -r . /opt/ezrec-backend/
sudo chown -R ezrec:ezrec /opt/ezrec-backend

# Create necessary directories
sudo mkdir -p /opt/ezrec-backend/{recordings,logs,temp,uploads,user_assets}
sudo chown -R ezrec:ezrec /opt/ezrec-backend
```

### 4. Setup Python Environment

```bash
cd /opt/ezrec-backend
sudo -u ezrec python3 -m venv venv
sudo -u ezrec /opt/ezrec-backend/venv/bin/pip install --upgrade pip
sudo -u ezrec /opt/ezrec-backend/venv/bin/pip install -r requirements.txt
```

### 5. Create systemd Services

Create the service files manually or use the ones generated by the setup script.

## Service Management

### Available Commands

```bash
# Start services
sudo /opt/ezrec-backend/manage.sh start

# Stop services
sudo /opt/ezrec-backend/manage.sh stop

# Restart services
sudo /opt/ezrec-backend/manage.sh restart

# Check status
sudo /opt/ezrec-backend/manage.sh status

# View logs
sudo /opt/ezrec-backend/manage.sh logs

# Health check
sudo /opt/ezrec-backend/manage.sh health

# Update application
sudo /opt/ezrec-backend/manage.sh update
```

### Service Details

The installation creates four systemd services:

1. **ezrec-backend.service** - Main service that coordinates everything
2. **ezrec-orchestrator.service** - Handles recording orchestration
3. **ezrec-scheduler.service** - Manages booking schedules
4. **ezrec-status.service** - Updates system status

### Viewing Logs

```bash
# View all EZREC logs
sudo journalctl -u ezrec-backend.service -f

# View specific service logs
sudo journalctl -u ezrec-orchestrator.service -f
sudo journalctl -u ezrec-scheduler.service -f
sudo journalctl -u ezrec-status.service -f

# View application logs
sudo tail -f /opt/ezrec-backend/logs/ezrec-orchestrator.log
```

## Configuration

### Camera Configuration

The system supports both Pi Camera and USB cameras:

#### Pi Camera
```env
CAMERA_DEVICE=/dev/video0
CAMERA_WIDTH=1920
CAMERA_HEIGHT=1080
CAMERA_FPS=30
```

#### USB Camera
```env
CAMERA_DEVICE=/dev/video0
CAMERA_WIDTH=1280
CAMERA_HEIGHT=720
CAMERA_FPS=30
```

### Recording Settings

```env
# Recording quality
CAMERA_WIDTH=1920
CAMERA_HEIGHT=1080
CAMERA_FPS=30

# Storage settings
RECORDING_DIR=/opt/ezrec-backend/recordings
MAX_RECORDING_DURATION=7200  # 2 hours
MIN_RECORDING_DURATION=300   # 5 minutes
```

### Network Configuration

The system automatically detects your IP address, but you can configure it manually:

```env
# Optional: Set static IP
IP_ADDRESS=192.168.1.100
```

## Troubleshooting

### Common Issues

#### 1. Camera Not Detected

```bash
# Check camera devices
v4l2-ctl --list-devices

# Test camera
v4l2-ctl --device=/dev/video0 --list-formats-ext

# Check camera permissions
ls -la /dev/video*
```

#### 2. Services Not Starting

```bash
# Check service status
sudo systemctl status ezrec-backend.service

# Check logs
sudo journalctl -u ezrec-backend.service -n 50

# Check environment file
sudo cat /opt/ezrec-backend/.env
```

#### 3. Permission Issues

```bash
# Fix permissions
sudo chown -R ezrec:ezrec /opt/ezrec-backend
sudo chmod -R 755 /opt/ezrec-backend
sudo chmod -R 777 /opt/ezrec-backend/{temp,recordings,logs,uploads}
```

#### 4. Python Dependencies

```bash
# Reinstall dependencies
cd /opt/ezrec-backend
sudo -u ezrec /opt/ezrec-backend/venv/bin/pip install -r requirements.txt
```

#### 5. Disk Space

```bash
# Check disk usage
df -h

# Clean up old recordings
sudo find /opt/ezrec-backend/recordings -name "*.mp4" -mtime +7 -delete

# Clean up logs
sudo find /opt/ezrec-backend/logs -name "*.log" -mtime +30 -delete
```

### Health Check

Run the health check to diagnose issues:

```bash
sudo /opt/ezrec-backend/health_check.sh
```

This will check:
- Service status
- Disk space
- Camera availability
- Network connectivity

## Monitoring

### System Monitoring

The system automatically monitors:
- CPU usage
- Memory usage
- Storage usage
- Network connectivity
- Camera status

### Log Rotation

Logs are automatically rotated:
- Application logs: 10MB max, 5 backups
- System logs: Managed by journald
- Daily rotation for large files

### Performance Optimization

For better performance on Raspberry Pi:

1. **Use SSD storage** (USB 3.0 SSD recommended)
2. **Increase swap space**:
   ```bash
   sudo dphys-swapfile swapoff
   sudo nano /etc/dphys-swapfile
   # Set CONF_SWAPSIZE=2048
   sudo dphys-swapfile setup
   sudo dphys-swapfile swapon
   ```

3. **Optimize camera settings**:
   ```env
   CAMERA_WIDTH=1280
   CAMERA_HEIGHT=720
   CAMERA_FPS=24
   ```

4. **Enable hardware acceleration**:
   ```env
   HARDWARE_ENCODER=h264_omx
   ```

## Security

### Firewall Configuration

```bash
# Allow only necessary ports
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### Service Isolation

The application runs as a dedicated user (`ezrec`) with minimal permissions.

### Regular Updates

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Update application
sudo /opt/ezrec-backend/manage.sh update
```

## Backup and Recovery

### Backup Configuration

```bash
# Backup configuration
sudo cp /opt/ezrec-backend/.env /opt/ezrec-backend/.env.backup

# Backup recordings (if needed)
sudo tar -czf recordings_backup.tar.gz /opt/ezrec-backend/recordings
```

### Recovery

```bash
# Restore configuration
sudo cp /opt/ezrec-backend/.env.backup /opt/ezrec-backend/.env

# Restart services
sudo /opt/ezrec-backend/manage.sh restart
```

## Support

For issues and questions:
1. Check the troubleshooting section
2. Review logs: `sudo /opt/ezrec-backend/manage.sh logs`
3. Run health check: `sudo /opt/ezrec-backend/manage.sh health`
4. Check system status: `sudo /opt/ezrec-backend/manage.sh status`

## Next Steps

After successful deployment:
1. Test camera recording
2. Verify Supabase connectivity
3. Test booking system integration
4. Monitor system performance
5. Set up monitoring alerts (optional) 